
<img width="1226" height="344" alt="AgeKeeperBanner_Cropped" src="https://github.com/user-attachments/assets/706c6b69-c43f-4a95-8605-07df03d7b007" />

# AgeKeeper

A Python wrapper for querying the Age of Empires II (AOE2) public stats API and downloading match replays, with a replay scraper included.

## What it does

- Download a match replay ZIP by `match_id` and optionally unzip it.
- Fetch match details, full player stats, a player's recent match list, campaign stats, and leaderboard data.
- Can be used as a Python package you can use in your own scripts, or as a CLI tool (in progess).
- Scrape replays from a range of match ids (see `replay_scraper.py`).

## Requirements

- Python 3 (tested with standard CPython)

## Quick start

Run the script directly to hit the default endpoints and print responses:

```bash
python fetch_replay.py
```

Scrape a range of replays using the scraper defaults:

```bash
python replay_scraper.py
```

Download a replay ZIP using the defaults (see `defaults` in the script):

```bash
python -c "from fetch_replay import fetch_endpoint, save_replay, defaults; resp = fetch_endpoint('replay', match_id=defaults['match_id']); save_replay(resp)"
```

## Configuration

Edit the `defaults` dict in `fetch_replay.py` to change:

- `destination_folder`: where replay ZIPs are saved (default: `replays`)
- `game`: game key (default: `age2`)
- `profile_id`: used for sample calls (default: Hera's profile ID)
- `match_id`: used for sample calls (default: a match from Hera's profile)
- `unzip`: whether to unzip downloaded replay ZIPs (default: `True`)
- `remove_zip`: whether to delete the ZIP after extraction (default: `True`)
- `headers`: default headers sent with API requests

Edit the `defaults` dict in `replay_scraper.py` to change:

- `request_interval`: delay between requests in seconds
- `back_off_delay`: base backoff delay when rate limited (seconds)
- `back_off_multiplier`: exponential backoff multiplier
- `max_back_off_delay`: maximum backoff delay (seconds)
- `start_id`: starting match ID
- `end_id`: ending match ID
- `count_backwards`: scrape from `start_id` down to `end_id` when `True`
- `unzip_replays`: whether to unzip downloaded replays
- `remove_zip`: whether to delete ZIPs after extraction
- `scrape_state_file`: scrape state file path

## Core functions

- `save_replay(response, destination_folder=..., unzip=..., remove_zip=...)`
- `fetch_player_match_list(profile_id, game=..., sortColumn='dateTime', sort_direction='DESC', match_type='3')`
- `fetch_leaderboard(region='7', match_type='3', console_match_type=15, search_player='', page=1, count=100, sort_column='rank', sort_direction='ASC')`
- `fetch_endpoint(endpoint_name, profile_id=..., match_id=..., headers=..., data=None)`
- `run_endpoint_tests()`

## Endpoints

The script currently supports these endpoint keys (see `endpoints` in `aoe2api.py`):

- `replay`
- `match_details`
- `player_stats`
- `player_match_list`
- `player_campaign_stats`
- `leaderboard`

## Notes and caveats

- The headers/payloads are based on requests captured from the official Age of Empires website and may change.
- `fetch_player_match_list` only returns the most recent matches; paging behavior appears limited to page 1.
- `match_type` values are partially documented in the comments in `fetch_replay.py` and may require further verification.
- The replay download endpoint requires both `matchId` and `profileId` query parameters, even though the `profileId` value does not appear to matter.

## Replay scraper CLI

Scrape a range of match IDs in ascending order:

```bash
python replay_scraper.py --start_id 450000000 --end_id 450010000 --request-interval 5
```

Scrape in descending order (from end to start), with exponential backoff:

```bash
python replay_scraper.py --start_id 453704499 --end_id 453700000 --count-backwards --back-off-delay 20 --back-off-multiplier 2 --max-back-off-delay 300
```

## Legal and usage

This is an unofficial script and is not affiliated with or endorsed by Microsoft or the Age of Empires team. Use responsibly and respect the terms of service of any API you call. It is unclear to what extent Microsoft will allow scraping of their API. Use at your own risk.

## AI Disclosure

This readme was auto-generated by AI. Some code was auto-filled using either Copilot or Codex, though all was reviewed by the author.
